<html>
  <head>
    <title>Compliance Monitoring</title>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
    />

    <!-- jQuery + Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- Authentication -->
    <script src="./authentication.js"></script>

    <!-- DataTables (legacy bundle) -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.js"
    ></script>

    <!-- Your custom script (if any) -->
    <script type="text/javascript" src="script/script.js"></script>

    <style>
      body {
        margin: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at top left, #101828, #020617);
        color: #e5e7eb;
      }

      .top_container {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        font-weight: 700;
        color: #fff;
        background: linear-gradient(90deg, #2563eb, #4f46e5, #0ea5e9);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.3);
      }

      .top_container a {
        margin-left: auto;
        color: #f9fafb;
        text-decoration: none;
        font-weight: 500;
        border: 1px solid rgba(248, 250, 252, 0.4);
        padding: 6px 12px;
        border-radius: 999px;
      }

      .top_container a:hover {
        background: rgba(15, 23, 42, 0.4);
      }

      .status-banner {
        margin: 12px auto 0;
        width: 95%;
        background: rgba(15, 23, 42, 0.85);
        border-radius: 999px;
        padding: 8px 20px;
        color: #e5e7eb;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.3);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
      }

      .middle_container {
        margin-top: 1%;
        width: 95%;
        margin-left: auto;
        margin-right: auto;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 18px;
        padding: 12px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.85);
        max-height: calc(100vh - 160px);
        overflow: auto; /* vertical + horizontal scroll */
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      table {
        width: 100%;
        min-width: 1200px; /* force horizontal scroll on smaller screens */
        border: 1px solid #1f2937;
        border-collapse: collapse;
      }

      .center {
        text-align: center;
      }

      td,
      th {
        background: #020617;
        color: #e5e7eb;
        text-align: center;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid #1f2937;
      }

      thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(90deg, #0f172a, #111827);
        z-index: 5;
        box-shadow: 0 2px 4px rgba(15, 23, 42, 0.9);
      }

      tfoot th {
        background: #020617;
        position: sticky;
        bottom: 0;
        z-index: 4;
      }

      .avail {
        color: #22c55e;
      }

      .not-avail {
        color: #ef4444;
      }

      .glyphicon {
        font-size: 20px;
      }

      #myTable_wrapper {
        width: 100%;
      }

      .dataTables_length {
        margin-top: 10px;
        color: #e5e7eb;
      }

      .dataTables_filter {
        margin-top: 10px;
        color: #e5e7eb;
      }

      .dataTables_filter input {
        background: #020617;
        border: 1px solid #4b5563;
        color: #e5e7eb;
        border-radius: 999px;
        padding: 4px 10px;
      }

      .dataTables_paginate a {
        color: #e5e7eb !important;
      }

      div.dt-buttons {
        position: relative;
        float: left;
        margin-left: 20px;
        margin-top: 8px;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .buttons-html5 {
        border-radius: 999px !important;
        border: 1px solid #4b5563 !important;
        background: #020617 !important;
        color: #e5e7eb !important;
      }

      .buttons-html5:hover {
        background: #111827 !important;
      }
    </style>
  </head>

  <body>
    <div class="container top_container">
      PROD Compliance Monitoring
      <a href="data/service_status.csv">Download CSV</a>
    </div>

    <div class="status-banner">
      <span class="status-dot"></span>
      <span>
        Live telemetry • Compliance data auto-refreshed every hour • Hover over
        rows for quick insights.
      </span>
    </div>

    <div class="container-fluid middle_container">
      <div class="row">
        <div class="col-sm-12 table-wrapper" id="data">
          <!-- Table will be injected here -->
        </div>
      </div>
    </div>

    <script>
      // ---- AUTH CHECK (unchanged logic) ----
      document.addEventListener("DOMContentLoaded", async () => {
        const uid = localStorage.getItem("uidd");
        const sessionId = localStorage.getItem("sessionid");

        if (!uid || !sessionId) {
          console.log("No auth tokens - redirecting to login");
          redirectToLogin();
          return;
        }

        try {
          const response = await fetch(
            "https://10.191.171.12:5443/EISHOME/awthenticationService/authenticatePortal/",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionId}`,
              },
              body: JSON.stringify({ uid }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Auth response:", data);

          if (data.status === 302 || data.success === true) {
            console.log("Authentication successful");
            // Continue with app
          } else {
            console.log("Authentication failed - redirecting");
            redirectToLogin();
          }
        } catch (error) {
          console.error("Auth error:", error);
          redirectToLogin();
        }
      });

      function redirectToLogin() {
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = `https://10.191.171.12:5443/EISHOME/?return_url=${currentUrl}`;
      }

      // ------------------ TABLE BUILDING ------------------ //
      function getData() {
        function createHeader(tr, table) {
          const thead = document.createElement("thead");

          // RAM & CPU Core REMOVED here
          const header_list = [
            "Server No.",
            "IP Address",
            "File System",
            "Last Updated",
            "Up Time",
            "Server Role",
            "OS Version",
            "Kernel Version",
            "Kernel Update",
            "Ace Version",
            "MQ Version",
            "Firewall",
            "RPM Count",
            "DS Agent",
            "Splunk",
            "Ragent",
            "Reference ID",
            "System time",
            "eisuser exp",
            "root exp",
            "SOCVA exp",
            "addmitam exp",
          ];

          for (var i = 0; i <= header_list.length - 1; i++) {
            const th = document.createElement("th");
            th.innerHTML = header_list[i];
            th.classList.add("center");
            tr.appendChild(th);
          }

          thead.appendChild(tr);
          table.appendChild(thead);
        }

        var monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            const table = document.createElement("table");
            const tbody = document.createElement("tbody");
            table.setAttribute("border", "1");
            table.classList.add("table");
            table.classList.add("table-bordered");
            table.classList.add("display");
            table.setAttribute("id", "myTable");

            const tr = document.createElement("tr");
            createHeader(tr, table);

            const data_div = document.getElementById("data");

            const row_data = this.responseText.split("\n");

            for (var i = 0; i < row_data.length - 1; i++) {
              const col = row_data[i].split(",");
              const col_length = col.length - 1;
              const tr1 = document.createElement("tr");
              const td_counter = document.createElement("td");
              td_counter.innerHTML = i + 1;
              tr1.appendChild(td_counter);

              // indexes to SKIP from CSV: RAM (5), CPU Core (6)
              const skipIndexes = [5, 6];

              for (let j = 0; j <= col_length; j++) {
                if (skipIndexes.includes(j)) {
                  continue;
                }

                const td_service = document.createElement("td");
                td_service.setAttribute("id", col[j]);

                if (col[j] == "DSrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ok-circle");
                  span_element.classList.add("avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "DSnotrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-remove-circle");
                  span_element.classList.add("not-avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "SPLrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ok-circle");
                  span_element.classList.add("avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "SPLnotrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-remove-circle");
                  span_element.classList.add("not-avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "Ragentrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ok-circle");
                  span_element.classList.add("avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "Ragentnotrunning") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-remove-circle");
                  span_element.classList.add("not-avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "active") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ok-circle");
                  span_element.classList.add("avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "inactive") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-remove-circle");
                  span_element.classList.add("not-avail");
                  td_service.appendChild(span_element);
                } else if (col[j] == "DS_someissue") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ban-circle");
                  td_service.appendChild(span_element);
                } else if (col[j] == "SPL_someissue") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ban-circle");
                  td_service.appendChild(span_element);
                } else if (col[j] == "undefined") {
                  span_element = document.createElement("span");
                  span_element.classList.add("glyphicon");
                  span_element.classList.add("glyphicon-ban-circle");
                  td_service.appendChild(span_element);
                } else if (col[j] == "") {
                  td_service.innerHTML = "issue";
                } else {
                  var foundMonths = monthNames.filter((month) =>
                    col[j].includes(month)
                  );
                  if (foundMonths.length > 0) {
                    const today = new Date();
                    const targetDate = new Date(col[j]);
                    const diffmili = targetDate - today;
                    const diff = Math.round(
                      diffmili / (1000 * 60 * 60 * 24)
                    );
                    td_service.innerHTML = col[j];

                    // Highlight expiry windows
                    if (diff <= 5) {
                      td_service.style.backgroundColor = "#7f1d1d"; // red-ish
                    } else if (diff >= 6 && diff <= 10) {
                      td_service.style.backgroundColor = "#78350f"; // amber-ish
                    } else if (diff >= 11 && diff <= 15) {
                      td_service.style.backgroundColor = "#713f12"; // yellow/brown
                    }
                  } else {
                    td_service.innerHTML = col[j];
                  }
                }
                tr1.appendChild(td_service);
                tbody.appendChild(tr1);
              }
            }

            const tfoot = document.createElement("tfoot");
            const tr_element = document.createElement("tr");

            // FOOTER HEADERS also without RAM & CPU Core
            const footer_headers = [
              "Server No.",
              "IP Address",
              "File System",
              "Last Updated",
              "Up Time",
              "Server Role",
              "OS Version",
              "Kernel Version",
              "Kernel Update",
              "Ace Version",
              "MQ Version",
              "Firewall",
              "RPM Count",
              "DS Agent",
              "Splunk",
              "Ragent",
              "Reference ID",
              "System time",
              "eisuser exp",
              "root exp",
              "SOCVA exp",
              "addmitam exp",
            ];

            for (var k = 0; k <= footer_headers.length - 1; k++) {
              const th = document.createElement("th");
              th.innerHTML = footer_headers[k];
              th.classList.add("center");
              tr_element.appendChild(th);
            }
            tfoot.appendChild(tr_element);

            table.appendChild(tbody);
            table.appendChild(tfoot);
            data_div.appendChild(table);
          }
        };
        let file_name = "data/combine.txt";
        xhttp.open("GET", file_name, true);
        xhttp.send();
        console.log("Table Created");
      }

      getData();
    </script>

    <!-- Newer DataTables (for scrolling & buttons) -->
    <script
      type="text/javascript"
      charset="utf8"
      src="https://code.jquery.com/jquery-3.7.1.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/2.1.4/js/dataTables.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.dataTables.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="vendor/datatables-plugins/dataTables.bootstrap.min.js"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="vendor/datatables-responsive/dataTables.responsive.js"
    ></script>

    <script>
      $(window).on("load", function () {
        initializeDataTable();
      });

      function initializeDataTable() {
        console.log("applying data table filter + scroll ....");
        var table = $("#myTable").DataTable({
          processing: true,
          pageLength: 10,
          dom: "lBfrtip",
          lengthMenu: [10, 25, 50, 100],
          scrollX: true,
          scrollY: "60vh", // vertical scroll
          scrollCollapse: true,
          buttons: [
            {
              extend: "collection",
              text: "Export",
              buttons: ["copy", "excel", "csv"],
            },
          ],
        });

        // Column-wise select filter in footer
        $("#myTable tfoot th").each(function (i) {
          var select = $('<select><option value=""></option></select>')
            .appendTo($(this).empty())
            .on("change", function () {
              table
                .column(i)
                .search($(this).val())
                .draw();
            });

          table
            .column(i)
            .data()
            .unique()
            .sort()
            .each(function (d) {
              if (d && d.toString().trim().length > 0) {
                select.append('<option value="' + d + '">' + d + "</option>");
              }
            });
        });

        console.log("table filter applied ....");
      }

      $(window).on("beforeunload", function () {
        // optional: destroy or re-init if needed
   
